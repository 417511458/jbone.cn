


<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <title>深入理解Zuul实现原理 — Jbone</title>
    <meta charset="utf-8">
    <meta name="description" content="Jbone - Spring Cloud微服务架构综合应用实践和基础开发框架">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="alternate" hreflang="x-default" href="https://jbone.cn/learn/spring-cloud/deep-zuul.html">

    <meta property="og:type" content="article">
    <meta property="og:title" content="深入理解Zuul实现原理 — Jbone">
    <meta property="og:description" content="深入理解Zuul实现原理">
    <meta property="og:keywords" content="Zuul，Spring Cloud，微服务">

    <meta property="og:image" content="https://jbone.cn//images/logo.png">

    <link rel="icon" href="/images/logo.png" type="image/png">

    <meta name="msapplication-TileColor" content="#4fc08d">
    <meta name="theme-color" content="#4fc08d">

    <meta name="msapplication-config" content="browserconfig.xml">


    <!-- <link href="https://fonts.googleapis.com" rel="preconnect" crossorigin> -->
    <!-- <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin> -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com" rel="preconnect" crossorigin> -->

    <!-- <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Roboto Mono' rel='stylesheet' type='text/css'> -->
    <!-- <link href='//fonts.googleapis.com/css?family=Dosis:500&text=Vue.js' rel='stylesheet' type='text/css'> -->

    <link href="//code.bdstatic.com/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- main page styles -->
    <link rel="stylesheet" href="/css/page.css">

    <!-- this needs to be loaded before guide's inline scripts -->
    <script src="/js/vue.js"></script>

    

    <script>
      Vue.config.productionTip = false
      window.PAGE_TYPE = "learn-spring-cloud"
    </script>

    <!-- 百度统计 -->
      <script>
          var _hmt = _hmt || [];
          (function() {
              var hm = document.createElement("script");
              hm.src = "https://hm.baidu.com/hm.js?bfc5a5993390f326fda3fcfadfcdb6d7";
              var s = document.getElementsByTagName("script")[0];
              s.parentNode.insertBefore(hm, s);
          })();
      </script>

  </head>
  <body class="docs">
    <div id="mobile-bar" >
      <a class="menu-button"></a>
      <a class="logo" href="/"></a>
    </div>
    <div id="header">
  <a id="logo" href="/">
    <img src="/images/logo.png" alt="vue logo">
    <span>Jbone</span>
  </a>
  <ul id="nav">
    <!--
<li>
  <form id="search-form">
    <input type="text" id="search-query-nav" class="search-query st-default-search-input" aria-label="搜索">
  </form>
</li>
-->
<li class="nav-dropdown-container learn">
  <a class="nav-link current">学习</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="/learn/cas/" class="nav-link">CAS</a></li>
    <li><a href="/learn/spring-cloud/" class="nav-link current">Spring Cloud</a></li>
  </ul>
</li>

<li class="nav-dropdown-container ecosystem">
  <a class="nav-link">生态系统</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="/sso/" class="nav-link">单点登录</a></li>
    <!--
    <li><a href="/service-management/" class="nav-link">服务治理</a></li>
    <li><a href="/file-system/" class="nav-link">文件系统</a></li>
    <li><a href="/system/" class="nav-link">权限管理</a></li>
    <li><a href="/cms/" class="nav-link">CMS</a></li>
    -->
  </ul>
</li>

<li class="nav-dropdown-container ecosystem">
  <a class="nav-link">技术翻译</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><h4>Spring Cloud</h4></li>
    <li>
      <ul>
        <li><a href="/translate/spring-cloud-netflix-zuul/" class="nav-link">Spring Cloud Netflix Zuul</a></li>
      </ul>
    </li>
    <li><h4>CAS</h4></li>
    <li>
      <ul>
        <li><a href="/translate/cas-services/" class="nav-link">CAS Services</a></li>
        <li><a href="/translate/cas-management/" class="nav-link">CAS Management</a></li>
      </ul>
    </li>
    <li><a href="/translate/join.html" class="nav-link"><b>我也要加入翻译</b></a></li>
  </ul>
</li>

<li><a href="/support-jbone/" target="_blank" class="nav-link contribute">支持jbone</a></li>

  </ul>
</div>

    
      <div id="main" class="fix-sidebar">
        
          
  

<div class="sidebar">
  <div class="sidebar-inner">
    
    <div class="list">
      
        <h2>
          
          
        </h2>
        <ul class="menu-root">
  
    
    
        

        
    <li>
      <a href="/learn/spring-cloud/index.html" class="sidebar-link">Spring Cloud</a>
    </li>
  
    
    
        

        
    <li>
      <a href="/learn/spring-cloud/deep-eureka.html" class="sidebar-link">深入理解Eureka实现原理</a>
    </li>
  
    
    
        

        
    <li>
      <a href="/learn/spring-cloud/deep-zuul.html" class="sidebar-link current">深入理解Zuul实现原理</a>
    </li>
  
</ul>

      
    </div>
  </div>
</div>


<div class="content learn-spring-cloud with-sidebar ">
  
    
      
<div id="ad">

</div>


    
  
  
    <h1>深入理解Zuul实现原理</h1>
  
<!--
  <div class="ad-pagetop" style="display:hidden">
</div>

-->
  
    <p><strong>本文是草稿，还没完成</strong></p>
<p>在当下流行的微服务架构中，面对多端应用时我们往往会做前后端分离：如前端分成APP端、网页端、小程序端等，使用Vue等流行的前端框架交给前端团队负责实现；后端拆分成若干微服务，分别交给不同的后端团队负责实现。</p>
<p>这样划分后前端怎么和后端接口交互呢？如果是前端页面分别调用各个微服务的接口，显然不太好，因为前端要知道每个微服务的细节，且很可能会导致调用链路混乱。</p>
<p>这个时候就需要有个组件负责前后端之间的交互，在微服务生态体系中我们将该组件称之为<strong>网关</strong>。</p>
<p>在Spring Cloud生态体系中，网关是其基础组件之一，它的主流实现方案有两个：</p>
<ol>
<li>Spring Cloud Netflix Zuul</li>
<li>Spring Cloud Gateway</li>
</ol>
<p>两者的主要作用都是一样的，都是代理和路由。两者的对比不在本文讨论范围内，本文主要聚焦于Spring Cloud Netflix Zuul。</p>
<p>本文的焦点主要是剖析Zuul内部的实现原理，如网关初始化过程、路由处理流程、过滤器种类及其功能、度量指标、管理端点等。</p>
<blockquote>
<p>Spring Cloud Netflix Zuul的集成方式非常简单，不是本文的重点，有需要的可以参考<a href="https://jbone.cn/translate/spring-cloud-netflix-zuul/">这里</a></p>
</blockquote>
<h2 id="Spring-Cloud-Netflix-Zuul架构总览"><a href="#Spring-Cloud-Netflix-Zuul架构总览" class="headerlink" title="Spring Cloud Netflix Zuul架构总览"></a>Spring Cloud Netflix Zuul架构总览</h2><p><img src="images/zuul_01.png" alt="架构图"></p>
<p>如上图所示，整体架构上可以分为两个部分，即Zuul Core和Spring Cloud Netflix Zuul。</p>
<p>其中Zuul Core部分即Zuul的核心，负责网关核心流程的实现；</p>
<p>Spring Cloud Netflix Zuul负责包装Zuul Core，其中包括Zuul服务的初始化、过滤器的加载、路由过滤器的实现等。</p>
<p>从上图中我们可以看出Zuul网关的工作流程：</p>
<ol>
<li><p>容器启动时，Spring Cloud初始化Zuul核心组件，如ZuulServlet、过滤器等。</p>
</li>
<li><p>ZuulServlet处理外部请求：</p>
<ol>
<li><p>初始化RequestContext</p>
</li>
<li><p>ZuulRunner发起执行Pre过滤器，并最终通过FilterProcessor执行</p>
</li>
<li><p>ZuulRunner发起执行Route过滤器，并最终通过FilterProcessor执行</p>
</li>
<li><p>ZuulRunner发起执行Post过滤器，并最终通过FilterProcessor执行</p>
</li>
<li><p>返回Http Response</p>
</li>
</ol>
</li>
</ol>
<h2 id="服务初始化过程"><a href="#服务初始化过程" class="headerlink" title="服务初始化过程"></a>服务初始化过程</h2><p>Spring Cloud Netflix Zuul中初始化网关服务有两种方式：<code>@EnableZuulServer</code>和<code>@EnableZuulProxy</code>。</p>
<p>这两种方式都可以启动网关服务，不同的主要地方是：</p>
<ol>
<li><code>@EnableZuulProxy</code>是<code>@EnableZuulServer</code>的超集，即使用<code>@EnableZuulProxy</code>加载的组件除了包含使用<code>@EnableZuulServer</code>加载的组件外，还增加了其他组件和功能；</li>
<li><code>@EnableZuulServer</code>是纯净版的网关服务，不具备代理功能，只实现了简单的请求转发、响应等基本功能，需要自行添加需要的组件；</li>
<li><code>@EnableZuulProxy</code>在<code>@EnableZuulServer</code>的基础上实现了代理功能，并可以通过服务发现来路由服务。</li>
</ol>
<p><img src="images/zuul_02.png" alt="初始化流程图"></p>
<p>如图所示，<code>@EnableZuulServer</code>和<code>@EnableZuulProxy</code>的初始化过程一致，最大的区别在于加载的过滤器不同。</p>
<p>其中蓝色是<code>@EnableZuulServer</code>加载的过滤器；红色是<code>@EnableZuulProxy</code>额外添加的过滤器。</p>
<h2 id="路由处理流程"><a href="#路由处理流程" class="headerlink" title="路由处理流程"></a>路由处理流程</h2><p>1、路由处理的流程<br>2、说明过滤器四个核心方法<br>3、说明包含Pre、Route、Post和Error四种类型过滤器</p>
<h3 id="Pre-Filter"><a href="#Pre-Filter" class="headerlink" title="Pre Filter"></a>Pre Filter</h3><p>描述Pre类型过滤器的功能</p>
<h3 id="Route-Filter"><a href="#Route-Filter" class="headerlink" title="Route Filter"></a>Route Filter</h3><p>描述Route类型过滤器的功能</p>
<h3 id="Post-Filter"><a href="#Post-Filter" class="headerlink" title="Post Filter"></a>Post Filter</h3><p>描述Post类型过滤器的功能</p>
<h3 id="Error-Filter"><a href="#Error-Filter" class="headerlink" title="Error Filter"></a>Error Filter</h3><p>描述Error类型过滤器的功能</p>
<h2 id="Metrixs"><a href="#Metrixs" class="headerlink" title="Metrixs"></a>Metrixs</h2><p>Zuul度量指标</p>
<h2 id="Endpoints"><a href="#Endpoints" class="headerlink" title="Endpoints"></a>Endpoints</h2><p>Zuul新增的管理端点</p>
<h2 id="关于作者"><a href="#关于作者" class="headerlink" title="关于作者"></a>关于作者</h2><p>马军伟，草根码农一枚，jbone项目作者。</p>
<p>关注领域：微服务、高并发编程、单点登录等。</p>
<p>Github：<a href="https://github.com/417511458" target="_blank" rel="noopener">https://github.com/417511458</a></p>
<p>Gitee: <a href="https://gitee.com/majunwei2017" target="_blank" rel="noopener">https://gitee.com/majunwei2017</a></p>
<p>主页：<a href="http://jbone.cn">http://jbone.cn</a></p>
<p>QQ: 417511458</p>
<p>公众号：writebugs</p>

  
  
  <div class="footer">
      <script src="//m.servedby-buysellads.com/monetization.js" type="text/javascript"></script>
<div id="bsa-native"></div>
</script>


        <p><b>原创文章，欢迎转载！但请务必保留全文，并说明出处!</b></p>
        <br />
        发现错误？想参与编辑？
    <a href="https://github.com/417511458/jbone.cn/blob/master/source/learn/spring-cloud/deep-zuul.md" rel="noopener" target="_blank">
      在 GitHub 上编辑此页！
    </a>
  </div>
</div>

        
      </div>
      <script src="/js/smooth-scroll.min.js"></script>
    

    <!-- main custom script for sidebars, version selects etc. -->
    <script src="/js/css.escape.js"></script>
    <script src="/js/common.js"></script>

  </body>
</html>
