


<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <title>CAS服务管理实现原理 — Jbone</title>
    <meta charset="utf-8">
    <meta name="description" content="Jbone - Spring Cloud微服务架构综合应用实践和基础开发框架">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="alternate" hreflang="x-default" href="https://jbone.cn/learn/cas/deep-service-management.html">

    <meta property="og:type" content="article">
    <meta property="og:title" content="CAS服务管理实现原理 — Jbone">
    <meta property="og:description" content="CAS服务管理实现原理">
    <meta property="og:keywords" content="CAS，服务管理，原理">

    <meta property="og:image" content="https://jbone.cn//images/logo.png">

    <link rel="icon" href="/images/logo.png" type="image/png">

    <meta name="msapplication-TileColor" content="#4fc08d">
    <meta name="theme-color" content="#4fc08d">

    <meta name="msapplication-config" content="browserconfig.xml">


    <!-- <link href="https://fonts.googleapis.com" rel="preconnect" crossorigin> -->
    <!-- <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin> -->
    <!-- <link href="https://maxcdn.bootstrapcdn.com" rel="preconnect" crossorigin> -->

    <!-- <link href='//fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,600|Roboto Mono' rel='stylesheet' type='text/css'> -->
    <!-- <link href='//fonts.googleapis.com/css?family=Dosis:500&text=Vue.js' rel='stylesheet' type='text/css'> -->

    <link href="//code.bdstatic.com/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet" type="text/css">

    <!-- main page styles -->
    <link rel="stylesheet" href="/css/page.css">

    <!-- this needs to be loaded before guide's inline scripts -->
    <script src="/js/vue.js"></script>

    

    <script>
      Vue.config.productionTip = false
      window.PAGE_TYPE = "learn-cas"
    </script>

    <!-- 百度统计 -->
      <script>
          var _hmt = _hmt || [];
          (function() {
              var hm = document.createElement("script");
              hm.src = "https://hm.baidu.com/hm.js?bfc5a5993390f326fda3fcfadfcdb6d7";
              var s = document.getElementsByTagName("script")[0];
              s.parentNode.insertBefore(hm, s);
          })();
      </script>

  </head>
  <body class="docs">
    <div id="mobile-bar" >
      <a class="menu-button"></a>
      <a class="logo" href="/"></a>
    </div>
    <div id="header">
  <a id="logo" href="/">
    <img src="/images/logo.png" alt="vue logo">
    <span>Jbone</span>
  </a>
  <ul id="nav">
    <!--
<li>
  <form id="search-form">
    <input type="text" id="search-query-nav" class="search-query st-default-search-input" aria-label="搜索">
  </form>
</li>
-->
<li class="nav-dropdown-container learn">
  <a class="nav-link current">学习</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="/learn/cas/" class="nav-link">CAS</a></li>
    <li><a href="/learn/spring-cloud/" class="nav-link">Spring Cloud</a></li>
  </ul>
</li>

<li class="nav-dropdown-container ecosystem">
  <a class="nav-link">生态系统</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="/sso/" class="nav-link">单点登录</a></li>
    <!--
    <li><a href="/service-management/" class="nav-link">服务治理</a></li>
    <li><a href="/file-system/" class="nav-link">文件系统</a></li>
    <li><a href="/system/" class="nav-link">权限管理</a></li>
    <li><a href="/cms/" class="nav-link">CMS</a></li>
    -->
  </ul>
</li>

<li class="nav-dropdown-container ecosystem">
  <a class="nav-link">技术翻译</a><span class="arrow"></span>
  <ul class="nav-dropdown">
    <li><a href="/translate/cas/" class="nav-link current">CAS</a></li>
    <li><a href="/translate/cas-management/" class="nav-link">CAS Management</a></li>
    <li><a href="/translate/join.html" class="nav-link"><b>我也要加入翻译</b></a></li>
  </ul>
</li>

<li><a href="/support-jbone/" target="_blank" class="nav-link contribute">支持jbone</a></li>

  </ul>
</div>

    
      <div id="main" class="fix-sidebar">
        
          
  

<div class="sidebar">
  <div class="sidebar-inner">
    
    <div class="list">
      
        <h2>
          
          
        </h2>
        <ul class="menu-root">
  
    
    
        

        
            
        
    <li>
      <a href="/learn/cas/index.html" class="sidebar-link">CAS</a>
    </li>
  
    
    
        

        
            
                <li><h3>实现原理</h3></li>
            
        
    <li>
      <a href="/learn/cas/deep-service-management.html" class="sidebar-link current">CAS服务管理实现原理</a>
    </li>
  
</ul>

      
    </div>
  </div>
</div>


<div class="content learn-cas with-sidebar ">
  
    
      
<div id="ad">

</div>


    
  
  
    <h1>CAS服务管理实现原理</h1>
  
<!--
  <div class="ad-pagetop" style="display:hidden">
</div>

-->
  
    <p>通常情况下，我们的单点登录认证中心要支持多个服务的统一认证。我们的实现步骤一般是先配置服务注册中心方案、然后配置授权服务、最后重启服务。</p>
<p>按以上步骤执行完，大部分都可以得到预期的服务管理目的。而有时候在登录的时候会遇到这种提示：<code>未认证授权的服务</code>。对于刚接触CAS的人来说，看到这个提示往往不知道该如何处理。出现这个错误的原因有很多，比如服务加载失败、服务更新失败、<code>serviceID</code>正则表达式写错等等，其实归根结底是一个原因：<code>在登录过程中校验授权服务时，没有找到匹配的服务</code>。</p>
<p>为什么没有匹配到授权服务？</p>
<p>内部的服务管理机制是什么样的？</p>
<p>应该怎么解决？</p>
<p>本文将深入剖析CAS服务管理原理，包括服务管理整体架构、服务初始化过程、服务更新机制、服务校验过程、以及服务管理工具等。通过本文至少可以有以下收获：</p>
<ol>
<li>全面深入的理解CAS中的服务管理原理；</li>
<li>可以快速处理实操过程中CAS服务管理相关问题；</li>
</ol>
<h2 id="CAS服务管理整体架构"><a href="#CAS服务管理整体架构" class="headerlink" title="CAS服务管理整体架构"></a>CAS服务管理整体架构</h2><p><img src="images/service-management-architecture.png" alt="CAS服务管理架构图"></p>
<p>如上图所示，CAS服务管理的整体架构可以分为三层：</p>
<ul>
<li>服务注册中心</li>
<li>服务管理器</li>
<li>服务管理组件</li>
</ul>
<h3 id="服务注册中心"><a href="#服务注册中心" class="headerlink" title="服务注册中心"></a>服务注册中心</h3><p>服务注册中心负责存储授权服务，它支持多种存储方案，如内存、JSON文件、JPA、Redis、MongoDb等等。</p>
<p>CAS中的服务注册中心实现方案通过实现ServiceRegistry接口来实现：</p>
<p><img src="images/service-management-serviceregistry.png" alt="服务管理注册中心"></p>
<h3 id="服务管理器"><a href="#服务管理器" class="headerlink" title="服务管理器"></a>服务管理器</h3><p>服务管理器负责管理服务注册中心。正是因为有了服务管理器，才实现了服务存储的透明化，使调用方对服务存储方式无感知。也使服务存储更容易扩展，开发者可以根据自己的需求来实现个性化存储。</p>
<p>CAS中的服务管理器实现方案通过实现ServicesManager接口来实现：</p>
<p><img src="images/service-management-servicesmanager.png" alt="服务管理器"></p>
<h3 id="服务管理组件"><a href="#服务管理组件" class="headerlink" title="服务管理组件"></a>服务管理组件</h3><p>我们在这里将服务管理的调用方的统称为服务管理组件。如登录组件在登录过程中需要通过服务管理器获取授权来校验服务、服务定时器定时更新授权服务、服务初始化组件需要在服务启动时初始化授权服务等等。</p>
<h2 id="服务初始化"><a href="#服务初始化" class="headerlink" title="服务初始化"></a>服务初始化</h2><p>启用服务初始化功能后（<code>cas.serviceRegistry.initFromJson=true</code>），服务启动的第一步就是进行服务初始化，其目的是将注册中心中的授权服务加载到服务管理器中。</p>
<blockquote>
<p>服务管理器充当访问服务的缓存层，后续的服务访问都要通过服务管理器。</p>
</blockquote>
<p><img src="images/service-management-init.png" alt="服务初始化过程"></p>
<p>服务的初始化过程包含以下几步：</p>
<ol>
<li>服务启动时，Spring会初始化服务初始化组件，并启动初始化流程；</li>
<li>服务初始化组件从配置的目录中加载收取服务，并保存到loadedList中；</li>
<li>再将loadedList中的授权服务逐个保存到服务注册中心（<strong>已存在的不更新</strong>）；（这里是开发人员配置的服务注册中心方案，如redis、jpa等）</li>
<li>将服务注册中心中的服务加载到服务管理器中；完成服务初始化。</li>
</ol>
<blockquote>
<p>不同的服务管理器还会基于servicesMap将服务保存到自己的服务集合中，以实现个性化管理策略。</p>
</blockquote>
<h2 id="服务更新机制"><a href="#服务更新机制" class="headerlink" title="服务更新机制"></a>服务更新机制</h2><p>CAS中的服务更新是通过定时调度来实现的，启用或关闭此功能通过<code>cas.serviceRegistry.schedule.enabled=true/false</code>来控制。</p>
<p><img src="images/service-management-update.png" alt="服务定时更新机制"></p>
<p>服务的更新过程包含以下几步：</p>
<ol>
<li>服务启动时，Spring容器初始化服务更新定时调度器；</li>
<li>服务更新定时调度器根据配置的策略，定时调用；</li>
<li>从服务注册中心加载授权服务集合，并将授权服务集合加载到服务管理器中；更新完成。</li>
</ol>
<h2 id="服务校验过程"><a href="#服务校验过程" class="headerlink" title="服务校验过程"></a>服务校验过程</h2><p>安全起见，CAS单点登录的过程中都要进行授权服务的校验。</p>
<p><img src="images/service-management-match.png" alt="服务校验"></p>
<p>服务的校验过程包含以下几步:</p>
<ol>
<li>服务启动时，Spring容器初始化服务校验组件<code>InitialFlowSetupAction</code>，并将其添加到登录流程里；</li>
<li>每次执行登录流程时，都要先执行<code>InitialFlowSetupAction</code>，来校验服务；</li>
<li>首先从请求中解析出service；</li>
<li>然后逐个匹配服务管理器中的授权服务；</li>
<li>如果匹配到，立即返回授权服务，并将该授权服务带入到上下文中，继续执行登录流程中的其他动作；</li>
<li>如果没有匹配到服务，抛出异常，在页面中出现<code>未认证授权的服务</code>提示。</li>
</ol>
<p>通过以上的服务校验过程，可以得到以下结论：</p>
<ol>
<li>服务正则表达式一定要拼写正确，否则可能会匹配不到，或者匹配错误。建议配置前现在本地用Java正则表达式测试以下。</li>
<li>如果页面出现<code>未认证授权的服务</code>提示，一定是服务匹配问题，要从这方面找原因和解决方案。</li>
</ol>
<h2 id="服务管理工具"><a href="#服务管理工具" class="headerlink" title="服务管理工具"></a>服务管理工具</h2><p>CAS官方推出的服务管理工具是：<code>CAS Management</code>。我们这里主要介绍CAS Management的功能和实现原理。</p>
<blockquote>
<p>了解完服务的加载、更新机制后，如果有个性化需求，我们也可以实现自己的服务管理工具。</p>
</blockquote>
<p>CAS Management在实现了服务管理功能基础上，还有两个核心亮点：服务版本控制和委托用户管理。</p>
<blockquote>
<p>服务管理基础功能就不介绍了，已经包含在了服务版本控制流程内。</p>
</blockquote>
<h3 id="服务版本控制"><a href="#服务版本控制" class="headerlink" title="服务版本控制"></a>服务版本控制</h3><p>服务的版本控制是通过在本地建立一个git仓库，然后通过操作这个git仓库，发布后同步到CAS Server服务注册中心中，最后通过服务管理的更新机制，同步到CAS Server中。</p>
<p>服务的版本控制的好处显而易见：</p>
<ol>
<li>保留了服务的历史状态，并可以随时回退到任意历史版本；</li>
<li>服务有了中间态，可有效控制服务的发布状态。</li>
</ol>
<p><img src="images/service-management-versioncontrol.png" alt="服务管理版本控制"></p>
<p>服务版本控制流程：</p>
<ol>
<li>CAS Management启动后会做两件事情：<ul>
<li>在本地创建一个git仓库，并以此作为JSON注册中心，创建VersionControlServicesManager；</li>
<li>创建CAS Server服务管理器：DefaultServicesManager或DomainServicesManager;</li>
</ul>
</li>
<li>管理员增加或编辑服务后，通过操作界面中的<code>提交</code>按钮提交本次变更；</li>
<li>提交后就会点亮<code>发布</code>按钮，<code>发布</code>后会将仓库中的服务通过CAS Server服务管理器同步到CAS Server服务注册中心；</li>
<li>最后CAS Server通过更新机制，同步到CAS Server服务管理器中。</li>
</ol>
<h3 id="委托用户管理"><a href="#委托用户管理" class="headerlink" title="委托用户管理"></a>委托用户管理</h3><p>CAS Management的委托用户管理功能类似github上的PR，在以上服务版本控制的前面多出了PR的步骤，即：</p>
<ol>
<li>委托用户编辑服务并提交PR；</li>
<li>管理员接受或拒绝委托用户的PR；</li>
<li>如果管理员接受，就会走以上的服务管理版本控制流程；</li>
<li>如果管理员拒绝，则会打回到委托用户，重新编辑。</li>
</ol>
<h2 id="关于作者"><a href="#关于作者" class="headerlink" title="关于作者"></a>关于作者</h2><p>马军伟，草根码农一枚，jbone项目作者。</p>
<p>关注领域：微服务、高并发编程、单点登录等。</p>
<p>Github：<a href="https://github.com/417511458" target="_blank" rel="noopener">https://github.com/417511458</a></p>
<p>Gitee: <a href="https://gitee.com/majunwei2017" target="_blank" rel="noopener">https://gitee.com/majunwei2017</a></p>
<p>主页：<a href="http://jbone.cn">http://jbone.cn</a></p>
<p>QQ: 417511458</p>
<p>公众号：writebugs</p>

  
  
  <div class="footer">
      <script src="//m.servedby-buysellads.com/monetization.js" type="text/javascript"></script>
<div id="bsa-native"></div>
</script>


        <p><b>原创文章，欢迎转载！但请务必保留全文，并说明出处!</b></p>
        <br />
        发现错误？想参与编辑？
    <a href="https://github.com/417511458/jbone.cn/blob/master/source/learn/cas/deep-service-management.md" rel="noopener" target="_blank">
      在 GitHub 上编辑此页！
    </a>
  </div>
</div>

        
      </div>
      <script src="/js/smooth-scroll.min.js"></script>
    

    <!-- main custom script for sidebars, version selects etc. -->
    <script src="/js/css.escape.js"></script>
    <script src="/js/common.js"></script>

  </body>
</html>
